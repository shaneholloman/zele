generator client {
  provider = "prisma-client"
  output   = "./src/generated"
}

datasource db {
  provider = "sqlite"
}

// Lifecycle status for account credentials stored in `Account`.
enum AccountStatus {
  active
  disabled
}

// Stores one OAuth credential set per (email, appId) pair.
// appId is the Google OAuth client ID used during login, enabling
// multiple OAuth apps per email (different quotas, scopes, etc.).
// Default is the Thunderbird client ID (the original/only client).
model Account {
  email         String
  appId         String
  accountStatus AccountStatus
  tokens        String // JSON-encoded OAuth2 Credentials
  createdAt     DateTime
  updatedAt     DateTime @updatedAt

  threadLists    ThreadList[]
  threads        Thread[]
  labels         Label?
  labelCounts    LabelCount?
  profiles       Profile?
  syncStates     SyncState[]
  calendarLists  CalendarList?
  calendarEvents CalendarEvent[]

  @@id([email, appId])
}

// Caches thread list/search responses per account and query parameters.
// Used for fast list/search rendering and reduced Gmail API calls.
model ThreadList {
  id         Int      @id @default(autoincrement())
  email      String
  appId      String
  folder     String
  query      String
  labelIds   String
  pageToken  String
  maxResults Int
  data       String // JSON blob of ThreadListResult
  ttlMs      Int
  createdAt  DateTime

  account Account @relation(fields: [email, appId], references: [email, appId], onDelete: Cascade)

  @@unique([email, appId, folder, query, labelIds, pageToken, maxResults])
}

// Caches hydrated thread payloads per account + thread ID.
// Used by mail read and post-mutation cache invalidation.
model Thread {
  id        Int      @id @default(autoincrement())
  email     String
  appId     String
  threadId  String
  data      String // JSON blob of ThreadData
  ttlMs     Int
  createdAt DateTime

  account Account @relation(fields: [email, appId], references: [email, appId], onDelete: Cascade)

  @@unique([email, appId, threadId])
}

// Caches label metadata per account (label id/name/type payload).
// Used by label list/get and related command outputs.
model Label {
  email     String
  appId     String
  data      String // JSON blob of label list
  ttlMs     Int
  createdAt DateTime

  account Account @relation(fields: [email, appId], references: [email, appId], onDelete: Cascade)

  @@id([email, appId])
}

// Caches unread counts per label per account.
// Used by label counts to avoid recomputing on every invocation.
model LabelCount {
  email     String
  appId     String
  data      String // JSON blob of label counts
  ttlMs     Int
  createdAt DateTime

  account Account @relation(fields: [email, appId], references: [email, appId], onDelete: Cascade)

  @@id([email, appId])
}

// Caches Gmail profile payload per account (totals/history id).
// Used by profile command and account metadata lookups.
model Profile {
  email     String
  appId     String
  data      String // JSON blob of profile
  ttlMs     Int
  createdAt DateTime

  account Account @relation(fields: [email, appId], references: [email, appId], onDelete: Cascade)

  @@id([email, appId])
}

// Caches calendar list per account.
// Used by cal list to avoid fetching calendar metadata on every invocation.
model CalendarList {
  email     String
  appId     String
  data      String // JSON blob of CalendarListItem[]
  ttlMs     Int
  createdAt DateTime

  account Account @relation(fields: [email, appId], references: [email, appId], onDelete: Cascade)

  @@id([email, appId])
}

// Caches calendar event list responses per account and query parameters.
// Used for fast cal events rendering and reduced Calendar API calls.
model CalendarEvent {
  id         Int      @id @default(autoincrement())
  email      String
  appId      String
  calendarId String
  timeMin    String
  timeMax    String
  query      String
  maxResults Int
  pageToken  String
  data       String // JSON blob of EventListResult
  ttlMs      Int
  createdAt  DateTime

  account Account @relation(fields: [email, appId], references: [email, appId], onDelete: Cascade)

  @@unique([email, appId, calendarId, timeMin, timeMax, query, maxResults, pageToken])
}

// Stores persistent per-account sync metadata as generic key/value pairs.
// Use this for lightweight sync cursors and markers that are not cached API
// payloads, for example `history_id` (incremental Gmail history cursor),
// `last_full_sync_at`, or other small account-scoped checkpoints.
model SyncState {
  email String
  appId String
  key   String
  value String

  account Account @relation(fields: [email, appId], references: [email, appId], onDelete: Cascade)

  @@id([email, appId, key])
}
